// ============================================
// BIBLIOFLOW DATABASE SCHEMA
// ============================================
// Questo schema definisce tutte le entità del sistema
// di prenotazione posti biblioteca universitaria

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  STUDENTE
  BIBLIOTECARIO
  ADMIN
}

enum StatoPosto {
  DISPONIBILE
  OCCUPATO
  MANUTENZIONE
  RISERVATO
}

enum StatoPrenotazione {
  CONFERMATA
  CHECK_IN
  COMPLETATA
  CANCELLATA
  NO_SHOW
  SCADUTA
}

enum StatoPrestito {
  ATTIVO
  RESTITUITO
  SCADUTO
  RINNOVATO
}

enum TipoNotifica {
  PRENOTAZIONE
  CHECK_IN_REMINDER
  SCADENZA_PRESTITO
  SISTEMA
  PROMO
  ALERT   // Per alert scadenze e avvisi urgenti
  INFO    // Per info generiche (posto liberato, etc)
}

enum TipoEvento {
  PRENOTAZIONE_CREATA
  PRENOTAZIONE_CANCELLATA
  CHECK_IN
  CHECK_OUT
  NO_SHOW
  PRESTITO_CREATO
  PRESTITO_RESTITUITO
  OVERRIDE_BIBLIOTECARIO
  AUTOMATION       // Per eventi da automazioni
  NO_SHOW_AUTO     // Per rilascio automatico no-show
}

enum TokenType {
  VERIF
  RESET
}

// ============================================
// MODELLI
// ============================================

// Utenti del sistema
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?   // Null se usa OAuth
  nome          String
  cognome       String
  matricola     String?   @unique // Solo per studenti
  ruolo         UserRole  @default(STUDENTE)
  
  // Preferenze
  isPendolare       Boolean @default(false)
  tragittoPendolare String? // JSON con dettagli tragitto
  postoPreferito    String?
  salaPreferita     String?
  
  // Accessibilità
  necessitaAccessibilita Boolean @default(false)
  preferenzeAccessibilita String? // JSON con preferenze specifiche
  altoContrasto          Boolean @default(false)
  
  // Notifiche
  notifichePush   Boolean @default(true)
  notificheEmail  Boolean @default(true)
  
  // Account
  emailVerificata Boolean   @default(false)
  attivo          Boolean   @default(true)
  ultimoAccesso   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relazioni
  prenotazioni  Prenotazione[]
  prestiti      Prestito[]
  notifiche     Notifica[]
  eventiLog     LogEvento[]    @relation("UtenteEvento")
  eventiTarget  LogEvento[]    @relation("TargetEvento")
  authTokens     AuthToken[]
  
  @@index([email])
  @@index([matricola])
  @@index([ruolo])
}

// Sale della biblioteca
model Sala {
  id          String  @id @default(cuid())
  nome        String
  piano       Int
  descrizione String?
  
  // Caratteristiche
  isSilenziosa   Boolean @default(false)
  isGruppi       Boolean @default(false)
  capienzaMax    Int
  
  // Orari
  orarioApertura String @default("08:00")
  orarioChiusura String @default("22:00")
  
  // Stato
  attiva    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relazioni
  posti Posto[]
  
  @@index([piano])
}

// Posti nella biblioteca
model Posto {
  id        String     @id @default(cuid())
  numero    String     // Es: "15B"
  salaId    String
  sala      Sala       @relation(fields: [salaId], references: [id])
  
  // Posizione sulla mappa
  coordinataX Float
  coordinataY Float
  
  // Caratteristiche
  haPresaElettrica  Boolean @default(false)
  haFinestra        Boolean @default(false)
  isAccessibile     Boolean @default(false) // Sedia a rotelle
  tavoloRegolabile  Boolean @default(false)
  
  // Stato
  stato     StatoPosto @default(DISPONIBILE)
  attivo    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  // Relazioni
  prenotazioni Prenotazione[]
  
  @@unique([salaId, numero])
  @@index([stato])
  @@index([salaId])
}

// Prenotazioni posti
model Prenotazione {
  id        String             @id @default(cuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id])
  postoId   String
  posto     Posto              @relation(fields: [postoId], references: [id])
  
  // Quando
  data          DateTime @db.Date
  oraInizio     DateTime @db.Time()
  oraFine       DateTime @db.Time()
  
  // Stato
  stato         StatoPrenotazione @default(CONFERMATA)
  
  // Check-in/out
  checkInAt     DateTime?
  checkOutAt    DateTime?
  
  // Opzioni
  marginePendolare    Boolean @default(false)
  minutiMarginePendolare Int @default(30)
  
  // Estensioni
  estesa          Boolean @default(false)
  oraFineOriginale DateTime? @db.Time()
  
  // Metadata
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relazioni
  eventi LogEvento[]
  
  @@index([userId])
  @@index([postoId])
  @@index([data])
  @@index([stato])
}

// Libri nel catalogo
model Libro {
  id            String  @id @default(cuid())
  isbn          String  @unique
  titolo        String
  autore        String
  editore       String?
  anno          Int?
  categoria     String?
  descrizione   String?
  
  // Posizione
  scaffale      String?
  piano         Int?
  
  // Copie
  copieTotali     Int @default(1)
  copieDisponibili Int @default(1)
  
  // Metadata
  copertina   String? // URL immagine
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relazioni
  prestiti Prestito[]
  
  @@index([titolo])
  @@index([autore])
  @@index([isbn])
}

// Prestiti libri
model Prestito {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  libroId   String
  libro     Libro         @relation(fields: [libroId], references: [id])
  
  // Date
  dataPrestito    DateTime @default(now())
  dataScadenza    DateTime
  dataRestituzione DateTime?
  
  // Stato
  stato     StatoPrestito @default(ATTIVO)
  rinnovi   Int           @default(0)
  maxRinnovi Int          @default(2)
  
  // Metadata
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([libroId])
  @@index([stato])
  @@index([dataScadenza])
}

// Notifiche utente
model Notifica {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  
  tipo      TipoNotifica
  titolo    String
  messaggio String
  
  // Link azione
  actionUrl String?
  actionLabel String?
  
  // Stato
  letta     Boolean  @default(false)
  lettaAt   DateTime?
  
  // Metadata
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([letta])
  @@index([createdAt])
}

// Log eventi per audit
model LogEvento {
  id        String     @id @default(cuid())
  tipo      TipoEvento
  
  // Chi ha fatto l'azione
  userId    String?
  user      User?      @relation("UtenteEvento", fields: [userId], references: [id])
  
  // Su chi/cosa è stata fatta
  targetUserId String?
  targetUser   User?   @relation("TargetEvento", fields: [targetUserId], references: [id])
  
  prenotazioneId String?
  prenotazione   Prenotazione? @relation(fields: [prenotazioneId], references: [id])
  
  // Dettagli
  descrizione String?
  dettagli    Json?    // Dati aggiuntivi
  
  // Metadata
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([tipo])
  @@index([userId])
  @@index([createdAt])
}

// Configurazione sistema
model ConfigurazioneSistema {
  id        String   @id @default(cuid())
  chiave    String   @unique
  valore    String
  tipo      String   @default("string") // string, number, boolean, json
  descrizione String?
  updatedAt DateTime @updatedAt
  
  @@index([chiave])
}

// Token per operazioni auth (verifica email, reset password)
model AuthToken {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  token     String    @unique
  type      TokenType
  used      Boolean   @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

